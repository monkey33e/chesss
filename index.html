<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="google-adsense-account" content="ca-pub-1748676401736913">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï≤¥Ïä§ vs AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 600px;
            width: 100%;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .game-status {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .chessboard {
            width: 480px;
            height: 480px;
            margin: 0 auto;
            border: 3px solid #8B4513;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .square.light {
            background-color: #f0d9b5;
        }

        .square.dark {
            background-color: #b58863;
        }

        .square.selected {
            background-color: #7fb069 !important;
            box-shadow: inset 0 0 0 3px #5a8a4a;
        }

        .square.possible-move {
            background-color: #ffeb3b !important;
            opacity: 0.8;
        }

        .square.last-move {
            background-color: #81c784 !important;
        }

        .square.check {
            background-color: #ff5722 !important;
            animation: checkPulse 1s infinite;
        }

        @keyframes checkPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .square:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .promotion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .promotion-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .promotion-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
        }

        .promotion-pieces {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .promotion-piece {
            font-size: 3rem;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .promotion-piece:hover {
            background: #f0f0f0;
            transform: scale(1.1);
            border-color: #667eea;
        }

        .piece {
            user-select: none;
            transition: transform 0.2s ease;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .difficulty-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .difficulty-label {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }

        .difficulty-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .difficulty-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .difficulty-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .thinking {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
            color: #666;
        }

        @media (max-width: 600px) {
            .chessboard {
                width: 320px;
                height: 320px;
            }
            
            .square {
                font-size: 1.8rem;
            }
            
            .game-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">‚ôî Ï≤¥Ïä§ vs AI ‚ôõ</h1>
            <div class="game-status" id="gameStatus">ÎãπÏã†Ïùò Ï∞®Î°ÄÏûÖÎãàÎã§ (Î∞±)</div>
        </div>
        
        <div class="chessboard" id="chessboard"></div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="newGame()">ÏÉà Í≤åÏûÑ</button>
            <button class="btn btn-secondary" onclick="undoMove()">Î¨¥Î•¥Í∏∞</button>
        </div>

        <div class="difficulty-section">
            <span class="difficulty-label">ÎÇúÏù¥ÎèÑ:</span>
            <button class="difficulty-btn" onclick="setDifficulty(1)">1</button>
            <button class="difficulty-btn" onclick="setDifficulty(2)">2</button>
            <button class="difficulty-btn active" onclick="setDifficulty(3)">3</button>
            <button class="difficulty-btn" onclick="setDifficulty(4)">4</button>
            <button class="difficulty-btn" onclick="setDifficulty(5)">5</button>
            <button class="difficulty-btn" onclick="setDifficulty(6)" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; border-color: #ff6b6b;">6 üëπ</button>
        </div>
        
        <div class="thinking" id="thinking" style="display: none;">
            AIÍ∞Ä ÏÉùÍ∞Å Ï§ëÏûÖÎãàÎã§... ü§î
        </div>
    </div>

    <!-- ÌîÑÎ°úÎ™®ÏÖò Î™®Îã¨ -->
    <div class="promotion-modal" id="promotionModal" style="display: none;">
        <div class="promotion-content">
            <div class="promotion-title">Ìè∞ÏùÑ ÏäπÍ∏âÏãúÌÇ¨ ÎßêÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
            <div class="promotion-pieces">
                <div class="promotion-piece" onclick="selectPromotion('queen')">‚ôï</div>
                <div class="promotion-piece" onclick="selectPromotion('rook')">‚ôñ</div>
                <div class="promotion-piece" onclick="selectPromotion('bishop')">‚ôó</div>
                <div class="promotion-piece" onclick="selectPromotion('knight')">‚ôò</div>
            </div>
        </div>
    </div>

    <script>
        // Ï≤¥Ïä§ Í≤åÏûÑ ÏÉÅÌÉú
        let board = [];
        let selectedSquare = null;
        let currentPlayer = 'white';
        let gameHistory = [];
        let isGameOver = false;
        let aiDifficulty = 3;
        let enPassantTarget = null; // ÏïôÌååÏÉÅ ÎåÄÏÉÅ ÏúÑÏπò
        let pendingPromotion = null; // ÎåÄÍ∏∞ Ï§ëÏù∏ ÌîÑÎ°úÎ™®ÏÖò
        let isInCheck = { white: false, black: false };

        // ÏÜåÎ¶¨ Ìö®Í≥º ÏÉùÏÑ±
        function createSound(frequency, duration, type = 'sine') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Ïù¥Îèô ÏÜåÎ¶¨
        function playMoveSound() {
            createSound(800, 0.1);
        }

        // Îßê Ïû°Îäî ÏÜåÎ¶¨
        function playCaptureSound() {
            createSound(400, 0.2, 'square');
            setTimeout(() => createSound(300, 0.15, 'square'), 100);
        }

        // Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏ Ìö®Í≥ºÏùå
        function playCheckmateSound() {
            // ÏäπÎ¶¨ Ìå°ÌååÎ†à Ìö®Í≥º
            const notes = [523, 659, 784, 1047]; // C, E, G, C (Ìïú Ïò•ÌÉÄÎ∏å ÏúÑ)
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    createSound(freq, 0.3, 'sine');
                    // ÌôîÏùå Ï∂îÍ∞Ä
                    setTimeout(() => createSound(freq * 1.25, 0.25, 'sine'), 50);
                }, index * 200);
            });
            
            // ÎßàÏßÄÎßâÏóê Í∏¥ ÏäπÎ¶¨Ïùå
            setTimeout(() => {
                createSound(1047, 0.8, 'sine');
                setTimeout(() => createSound(1319, 0.6, 'sine'), 100);
            }, 800);
        }

        // Ï≤¥Ïä§ Îßê Ïú†ÎãàÏΩîÎìú
        const pieces = {
            white: {
                king: '‚ôî', queen: '‚ôï', rook: '‚ôñ', 
                bishop: '‚ôó', knight: '‚ôò', pawn: '‚ôô'
            },
            black: {
                king: '‚ôö', queen: '‚ôõ', rook: '‚ôú', 
                bishop: '‚ôù', knight: '‚ôû', pawn: '‚ôü'
            }
        };

        // Ï¥àÍ∏∞ Î≥¥Îìú ÏÑ§Ï†ï
        function initializeBoard() {
            board = [
                ['‚ôú','‚ôû','‚ôù','‚ôõ','‚ôö','‚ôù','‚ôû','‚ôú'],
                ['‚ôü','‚ôü','‚ôü','‚ôü','‚ôü','‚ôü','‚ôü','‚ôü'],
                [null,null,null,null,null,null,null,null],
                [null,null,null,null,null,null,null,null],
                [null,null,null,null,null,null,null,null],
                [null,null,null,null,null,null,null,null],
                ['‚ôô','‚ôô','‚ôô','‚ôô','‚ôô','‚ôô','‚ôô','‚ôô'],
                ['‚ôñ','‚ôò','‚ôó','‚ôï','‚ôî','‚ôó','‚ôò','‚ôñ']
            ];
        }

        // Î≥¥Îìú Î†åÎçîÎßÅ
        function renderBoard() {
            const chessboard = document.getElementById('chessboard');
            chessboard.innerHTML = '';

            // Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏
            checkForCheck();

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.row = row;
                    square.dataset.col = col;
                    
                    // Ï≤¥ÌÅ¨ ÏÉÅÌÉúÏù∏ ÌÇπ ÌïòÏù¥ÎùºÏù¥Ìä∏
                    const piece = board[row][col];
                    if (piece === '‚ôî' && isInCheck.white) {
                        square.classList.add('check');
                    } else if (piece === '‚ôö' && isInCheck.black) {
                        square.classList.add('check');
                    }
                    
                    if (piece) {
                        const pieceElement = document.createElement('span');
                        pieceElement.className = 'piece';
                        pieceElement.textContent = piece;
                        square.appendChild(pieceElement);
                    }
                    
                    square.addEventListener('click', () => handleSquareClick(row, col));
                    chessboard.appendChild(square);
                }
            }
        }

        // ÎßêÏùò ÏÉâÍπî ÌôïÏù∏
        function getPieceColor(piece) {
            if (!piece) return null;
            return '‚ôî‚ôï‚ôñ‚ôó‚ôò‚ôô'.includes(piece) ? 'white' : 'black';
        }

        // Ïú†Ìö®Ìïú Ïù¥ÎèôÏù∏ÏßÄ ÌôïÏù∏
        function isValidMove(fromRow, fromCol, toRow, toCol) {
            const piece = board[fromRow][fromCol];
            if (!piece) return false;

            const pieceColor = getPieceColor(piece);
            const targetPiece = board[toRow][toCol];
            
            // Í∞ôÏùÄ ÏÉâ ÎßêÏùÑ Ïû°ÏùÑ Ïàò ÏóÜÏùå
            if (targetPiece && getPieceColor(targetPiece) === pieceColor) {
                return false;
            }

            const rowDiff = Math.abs(toRow - fromRow);
            const colDiff = Math.abs(toCol - fromCol);

            // Í∞Å ÎßêÏùò Ïù¥Îèô Í∑úÏπô
            switch (piece) {
                case '‚ôô': // Î∞± Ìè∞
                    if (fromRow === 6 && toRow === 4 && colDiff === 0 && !board[5][fromCol] && !board[4][fromCol]) return true;
                    if (toRow === fromRow - 1 && colDiff === 0 && !targetPiece) return true;
                    if (toRow === fromRow - 1 && colDiff === 1 && targetPiece) return true;
                    // ÏïôÌååÏÉÅ
                    if (toRow === fromRow - 1 && colDiff === 1 && !targetPiece && 
                        enPassantTarget && enPassantTarget[0] === toRow && enPassantTarget[1] === toCol) return true;
                    return false;
                
                case '‚ôü': // Ìùë Ìè∞
                    if (fromRow === 1 && toRow === 3 && colDiff === 0 && !board[2][fromCol] && !board[3][fromCol]) return true;
                    if (toRow === fromRow + 1 && colDiff === 0 && !targetPiece) return true;
                    if (toRow === fromRow + 1 && colDiff === 1 && targetPiece) return true;
                    // ÏïôÌååÏÉÅ
                    if (toRow === fromRow + 1 && colDiff === 1 && !targetPiece && 
                        enPassantTarget && enPassantTarget[0] === toRow && enPassantTarget[1] === toCol) return true;
                    return false;

                case '‚ôñ': case '‚ôú': // Î£©
                    if (rowDiff === 0 || colDiff === 0) {
                        return isPathClear(fromRow, fromCol, toRow, toCol);
                    }
                    return false;

                case '‚ôó': case '‚ôù': // ÎπÑÏàç
                    if (rowDiff === colDiff) {
                        return isPathClear(fromRow, fromCol, toRow, toCol);
                    }
                    return false;

                case '‚ôï': case '‚ôõ': // ÌÄ∏
                    if (rowDiff === 0 || colDiff === 0 || rowDiff === colDiff) {
                        return isPathClear(fromRow, fromCol, toRow, toCol);
                    }
                    return false;

                case '‚ôò': case '‚ôû': // ÎÇòÏù¥Ìä∏
                    return (rowDiff === 2 && colDiff === 1) || (rowDiff === 1 && colDiff === 2);

                case '‚ôî': case '‚ôö': // ÌÇπ
                    return rowDiff <= 1 && colDiff <= 1;
            }
            return false;
        }

        // Í≤ΩÎ°úÍ∞Ä ÎπÑÏñ¥ÏûàÎäîÏßÄ ÌôïÏù∏
        function isPathClear(fromRow, fromCol, toRow, toCol) {
            const rowStep = toRow > fromRow ? 1 : toRow < fromRow ? -1 : 0;
            const colStep = toCol > fromCol ? 1 : toCol < fromCol ? -1 : 0;
            
            let currentRow = fromRow + rowStep;
            let currentCol = fromCol + colStep;
            
            while (currentRow !== toRow || currentCol !== toCol) {
                if (board[currentRow][currentCol]) return false;
                currentRow += rowStep;
                currentCol += colStep;
            }
            return true;
        }

        // ÏÇ¨Í∞ÅÌòï ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        function handleSquareClick(row, col) {
            if (isGameOver || currentPlayer !== 'white' || pendingPromotion) return;

            const clickedPiece = board[row][col];
            
            if (selectedSquare) {
                const [selectedRow, selectedCol] = selectedSquare;
                
                if (row === selectedRow && col === selectedCol) {
                    // Í∞ôÏùÄ ÏÇ¨Í∞ÅÌòï ÌÅ¥Î¶≠ - ÏÑ†ÌÉù Ìï¥Ï†ú
                    selectedSquare = null;
                    clearHighlights();
                } else if (isValidMove(selectedRow, selectedCol, row, col) && 
                          wouldResolveCheck(selectedRow, selectedCol, row, col, 'white')) {
                    // Ïú†Ìö®Ìïú Ïù¥ÎèôÏù¥Í≥† Ï≤¥ÌÅ¨Î•º Ìï¥Í≤∞ÌïòÎäî Ïù¥Îèô
                    makeMove(selectedRow, selectedCol, row, col);
                    selectedSquare = null;
                    clearHighlights();
                    
                    if (!isGameOver && !pendingPromotion) {
                        setTimeout(() => {
                            aiMove();
                        }, 500);
                    }
                } else {
                    // ÏÉàÎ°úÏö¥ Îßê ÏÑ†ÌÉù
                    if (clickedPiece && getPieceColor(clickedPiece) === 'white') {
                        selectedSquare = [row, col];
                        highlightSquare(row, col);
                        showPossibleMoves(row, col);
                    } else {
                        selectedSquare = null;
                        clearHighlights();
                    }
                }
            } else {
                // ÏÉàÎ°úÏö¥ ÏÑ†ÌÉù
                if (clickedPiece && getPieceColor(clickedPiece) === 'white') {
                    selectedSquare = [row, col];
                    highlightSquare(row, col);
                    showPossibleMoves(row, col);
                }
            }
        }

        // Ïù¥Îèô Ïã§Ìñâ
        function makeMove(fromRow, fromCol, toRow, toCol) {
            const piece = board[fromRow][fromCol];
            const capturedPiece = board[toRow][toCol];
            let isEnPassant = false;
            
            // ÏïôÌååÏÉÅ Ï≤òÎ¶¨
            if ((piece === '‚ôô' || piece === '‚ôü') && !capturedPiece && Math.abs(toCol - fromCol) === 1) {
                if (enPassantTarget && enPassantTarget[0] === toRow && enPassantTarget[1] === toCol) {
                    isEnPassant = true;
                    const capturedRow = piece === '‚ôô' ? toRow + 1 : toRow - 1;
                    board[capturedRow][toCol] = null; // ÏïôÌååÏÉÅÏúºÎ°ú Ïû°Ìûå Ìè∞ Ï†úÍ±∞
                }
            }
            
            // ÏÜåÎ¶¨ Ïû¨ÏÉù
            if (capturedPiece || isEnPassant) {
                playCaptureSound();
            } else {
                playMoveSound();
            }
            
            // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï†ÄÏû•
            gameHistory.push({
                from: [fromRow, fromCol],
                to: [toRow, toCol],
                piece: piece,
                captured: capturedPiece,
                player: currentPlayer,
                enPassantTarget: enPassantTarget,
                isEnPassant: isEnPassant
            });
            
            // ÏïôÌååÏÉÅ ÌÉÄÍ≤ü ÏóÖÎç∞Ïù¥Ìä∏
            enPassantTarget = null;
            if ((piece === '‚ôô' && fromRow === 6 && toRow === 4) || 
                (piece === '‚ôü' && fromRow === 1 && toRow === 3)) {
                enPassantTarget = [piece === '‚ôô' ? 5 : 2, fromCol];
            }
            
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;
            
            // ÌîÑÎ°úÎ™®ÏÖò Ï≤¥ÌÅ¨
            if ((piece === '‚ôô' && toRow === 0) || (piece === '‚ôü' && toRow === 7)) {
                if (currentPlayer === 'white') {
                    // ÌîåÎ†àÏù¥Ïñ¥ ÌîÑÎ°úÎ™®ÏÖò
                    pendingPromotion = { row: toRow, col: toCol, color: 'white' };
                    document.getElementById('promotionModal').style.display = 'flex';
                    return; // ÌîÑÎ°úÎ™®ÏÖò ÏÑ†ÌÉùÍπåÏßÄ ÎåÄÍ∏∞
                } else {
                    // AI ÌîÑÎ°úÎ™®ÏÖò (ÏûêÎèôÏúºÎ°ú ÌÄ∏ ÏÑ†ÌÉù)
                    board[toRow][toCol] = '‚ôõ';
                }
            }
            
            // ÌÇπÏù¥ Ïû°ÌòîÎäîÏßÄ ÌôïÏù∏
            if (capturedPiece === '‚ôö' || capturedPiece === '‚ôî') {
                isGameOver = true;
                const winner = currentPlayer === 'white' ? 'Î∞±' : 'Ìùë';
                document.getElementById('gameStatus').textContent = `Í≤åÏûÑ Ï¢ÖÎ£å! ${winner}Ïùò ÏäπÎ¶¨!`;
                renderBoard();
                playCheckmateSound();
                return;
            }
            
            // ÌîåÎ†àÏù¥Ïñ¥ Î≥ÄÍ≤Ω
            currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
            
            // Î≥¥Îìú Î®ºÏ†Ä Î†åÎçîÎßÅ
            renderBoard();
            updateGameStatus();
            
            // Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏ ÌôïÏù∏ (Î≥¥Îìú Î†åÎçîÎßÅ ÌõÑ)
            setTimeout(() => {
                if (isCheckmate(currentPlayer)) {
                    isGameOver = true;
                    const winner = currentPlayer === 'white' ? 'Ìùë' : 'Î∞±';
                    document.getElementById('gameStatus').textContent = `Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏! ${winner}Ïùò ÏäπÎ¶¨!`;
                    playCheckmateSound();
                }
            }, 100);
        }

        // AI Ïù¥Îèô
        function aiMove() {
            if (isGameOver || currentPlayer !== 'black') return;
            
            document.getElementById('thinking').style.display = 'block';
            
            setTimeout(() => {
                const possibleMoves = getAllPossibleMoves('black');
                
                if (possibleMoves.length === 0) {
                    isGameOver = true;
                    document.getElementById('gameStatus').textContent = 'Í≤åÏûÑ Ï¢ÖÎ£å! Î∞±Ïùò ÏäπÎ¶¨!';
                    document.getElementById('thinking').style.display = 'none';
                    renderBoard();
                    playCheckmateSound();
                    return;
                }
                
                // ÎÇúÏù¥ÎèÑÎ≥Ñ AI Î°úÏßÅ
                let bestMove = null;
                let bestScore = -1000;
                
                // ÎÇúÏù¥ÎèÑ 6: Ï†àÎåÄ Ïù¥Í∏∏ Ïàò ÏóÜÎäî AI (ÎØ∏ÎãàÎß•Ïä§ ÏïåÍ≥†Î¶¨Ï¶ò ÏãúÎÆ¨Î†àÏù¥ÏÖò)
                if (aiDifficulty === 6) {
                    bestMove = getBestMoveAdvanced(possibleMoves);
                } else {
                    for (const move of possibleMoves) {
                        let score = 0;
                        
                        // ÎÇúÏù¥ÎèÑ 1: ÏôÑÏ†Ñ ÎûúÎç§
                        if (aiDifficulty === 1) {
                            score = Math.random() * 100;
                        } else {
                            // Í∏∞Î≥∏ ÎûúÎç§ ÏöîÏÜå (ÎÇúÏù¥ÎèÑÍ∞Ä ÎÜíÏùÑÏàòÎ°ù Ï§ÑÏñ¥Îì¶)
                            score = Math.random() * (60 - aiDifficulty * 10);
                            
                            // ÏÉÅÎåÄ ÎßêÏùÑ Ïû°ÏùÑ Ïàò ÏûàÏúºÎ©¥ ÎÜíÏùÄ Ï†êÏàò
                            if (board[move.to[0]][move.to[1]]) {
                                const capturedPiece = board[move.to[0]][move.to[1]];
                                let captureScore = 0;
                                if (capturedPiece === '‚ôî') captureScore = 1000; // ÌÇπ
                                else if (capturedPiece === '‚ôï') captureScore = 90; // ÌÄ∏
                                else if (capturedPiece === '‚ôñ') captureScore = 50; // Î£©
                                else if (capturedPiece === '‚ôó' || capturedPiece === '‚ôò') captureScore = 30; // ÎπÑÏàç, ÎÇòÏù¥Ìä∏
                                else if (capturedPiece === '‚ôô') captureScore = 10; // Ìè∞
                                
                                score += captureScore * (aiDifficulty / 5);
                            }
                            
                            // ÎÇúÏù¥ÎèÑ 3 Ïù¥ÏÉÅ: Ï§ëÏïô Ï†úÏñ¥ Í≥†Î†§
                            if (aiDifficulty >= 3) {
                                const centerDistance = Math.abs(3.5 - move.to[0]) + Math.abs(3.5 - move.to[1]);
                                score += (7 - centerDistance) * aiDifficulty;
                            }
                            
                            // ÎÇúÏù¥ÎèÑ 4 Ïù¥ÏÉÅ: ÎßêÏùò ÏïàÏ†ÑÏÑ± Í≥†Î†§
                            if (aiDifficulty >= 4) {
                                // Í≥µÍ≤©Î∞õÏùÑ Ïàò ÏûàÎäî ÏúÑÏπòÏù∏ÏßÄ ÌôïÏù∏
                                let isUnderAttack = false;
                                for (let row = 0; row < 8; row++) {
                                    for (let col = 0; col < 8; col++) {
                                        const piece = board[row][col];
                                        if (piece && getPieceColor(piece) === 'white') {
                                            if (isValidMove(row, col, move.to[0], move.to[1])) {
                                                isUnderAttack = true;
                                                break;
                                            }
                                        }
                                    }
                                    if (isUnderAttack) break;
                                }
                                if (isUnderAttack) score -= 20;
                            }
                            
                            // ÎÇúÏù¥ÎèÑ 5: Îçî ÍπäÏùÄ Ï†ÑÎûµÏ†Å ÏÇ¨Í≥†
                            if (aiDifficulty === 5) {
                                // ÌÇπ ÏïàÏ†ÑÏÑ±
                                const kingPos = findKing('black');
                                if (kingPos) {
                                    const kingDistance = Math.abs(kingPos[0] - move.to[0]) + Math.abs(kingPos[1] - move.to[1]);
                                    if (kingDistance < 3) score += 5; // ÌÇπ Í∑ºÏ≤òÏóêÏÑú Î∞©Ïñ¥
                                }
                                
                                // Ìè∞ Íµ¨Ï°∞ Í≥†Î†§
                                if (move.piece === '‚ôü') {
                                    if (move.to[0] > 4) score += 15; // Ï†ÑÏßÑÌïú Ìè∞Ïóê Î≥¥ÎÑàÏä§
                                }
                            }
                        }
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestMove = move;
                        }
                    }
                }
                
                if (bestMove) {
                    makeMove(bestMove.from[0], bestMove.from[1], bestMove.to[0], bestMove.to[1]);
                }
                
                document.getElementById('thinking').style.display = 'none';
            }, 1000);
        }

        // Î™®Îì† Í∞ÄÎä•Ìïú Ïù¥Îèô Í∞ÄÏ†∏Ïò§Í∏∞
        function getAllPossibleMoves(color) {
            const moves = [];
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece && getPieceColor(piece) === color) {
                        for (let toRow = 0; toRow < 8; toRow++) {
                            for (let toCol = 0; toCol < 8; toCol++) {
                                if (isValidMove(row, col, toRow, toCol) && 
                                    wouldResolveCheck(row, col, toRow, toCol, color)) {
                                    moves.push({
                                        from: [row, col],
                                        to: [toRow, toCol],
                                        piece: piece
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            return moves;
        }

        // ÌïòÏù¥ÎùºÏù¥Ìä∏ ÌëúÏãú
        function highlightSquare(row, col) {
            clearHighlights();
            const square = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            square.classList.add('selected');
        }

        // Ïù¥Îèô Í∞ÄÎä•Ìïú Ïπ∏ ÌëúÏãú
        function showPossibleMoves(row, col) {
            const pieceColor = getPieceColor(board[row][col]);
            for (let toRow = 0; toRow < 8; toRow++) {
                for (let toCol = 0; toCol < 8; toCol++) {
                    if (isValidMove(row, col, toRow, toCol) && 
                        wouldResolveCheck(row, col, toRow, toCol, pieceColor)) {
                        const square = document.querySelector(`[data-row="${toRow}"][data-col="${toCol}"]`);
                        square.classList.add('possible-move');
                    }
                }
            }
        }

        // ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
        function clearHighlights() {
            document.querySelectorAll('.square').forEach(square => {
                square.classList.remove('selected', 'possible-move', 'last-move');
            });
        }

        // ÌÇπ ÏúÑÏπò Ï∞æÍ∏∞
        function findKing(color) {
            const kingPiece = color === 'white' ? '‚ôî' : '‚ôö';
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (board[row][col] === kingPiece) {
                        return [row, col];
                    }
                }
            }
            return null;
        }

        // ÎßêÏùò Í∞ÄÏπò Í≥ÑÏÇ∞
        function getPieceValue(piece) {
            if (!piece) return 0;
            switch (piece) {
                case '‚ôî': case '‚ôö': return 1000;
                case '‚ôï': case '‚ôõ': return 90;
                case '‚ôñ': case '‚ôú': return 50;
                case '‚ôó': case '‚ôù': case '‚ôò': case '‚ôû': return 30;
                case '‚ôô': case '‚ôü': return 10;
                default: return 0;
            }
        }

        // Î≥¥Îìú ÌèâÍ∞Ä Ìï®Ïàò (ÎÇúÏù¥ÎèÑ 6Ïö©)
        function evaluateBoard() {
            let score = 0;
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece) {
                        const value = getPieceValue(piece);
                        const color = getPieceColor(piece);
                        
                        if (color === 'black') {
                            score += value;
                            // ÏúÑÏπò Î≥¥ÎÑàÏä§
                            if (piece === '‚ôü' && row > 4) score += 5; // Ï†ÑÏßÑÌïú Ìè∞
                            if ((piece === '‚ôù' || piece === '‚ôû') && row > 2 && row < 6 && col > 1 && col < 6) score += 5; // Ï§ëÏïô Ï†úÏñ¥
                        } else {
                            score -= value;
                            // ÏÉÅÎåÄÎ∞© ÏúÑÏπò ÌéòÎÑêÌã∞
                            if (piece === '‚ôô' && row < 4) score -= 5;
                        }
                    }
                }
            }
            
            // ÌÇπ ÏïàÏ†ÑÏÑ± ÌèâÍ∞Ä
            const blackKing = findKing('black');
            const whiteKing = findKing('white');
            
            if (blackKing) {
                // ÌÇπ Ï£ºÎ≥Ä ÏïàÏ†ÑÏÑ± Ï≤¥ÌÅ¨
                let safeSquares = 0;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const newRow = blackKing[0] + dr;
                        const newCol = blackKing[1] + dc;
                        if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                            if (!isSquareUnderAttack(newRow, newCol, 'white')) {
                                safeSquares++;
                            }
                        }
                    }
                }
                score += safeSquares * 2;
            }
            
            return score;
        }

        // ÌäπÏ†ï ÏúÑÏπòÍ∞Ä Í≥µÍ≤©Î∞õÍ≥† ÏûàÎäîÏßÄ ÌôïÏù∏
        function isSquareUnderAttack(row, col, attackerColor) {
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece && getPieceColor(piece) === attackerColor) {
                        if (isValidMove(r, c, row, col)) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        // Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏
        function checkForCheck() {
            const whiteKing = findKing('white');
            const blackKing = findKing('black');
            
            isInCheck.white = whiteKing ? isSquareUnderAttack(whiteKing[0], whiteKing[1], 'black') : false;
            isInCheck.black = blackKing ? isSquareUnderAttack(blackKing[0], blackKing[1], 'white') : false;
        }

        // Ïù¥ÎèôÏù¥ Ï≤¥ÌÅ¨Î•º Ìï¥Í≤∞ÌïòÎäîÏßÄ ÌôïÏù∏
        function wouldResolveCheck(fromRow, fromCol, toRow, toCol, color) {
            const piece = board[fromRow][fromCol];
            const captured = board[toRow][toCol];
            
            // ÏûÑÏãúÎ°ú Ïù¥Îèô Ïã§Ìñâ
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;
            
            const kingPos = findKing(color);
            const stillInCheck = kingPos ? isSquareUnderAttack(kingPos[0], kingPos[1], color === 'white' ? 'black' : 'white') : false;
            
            // Ïù¥Îèô Î≥µÏõê
            board[fromRow][fromCol] = piece;
            board[toRow][toCol] = captured;
            
            return !stillInCheck;
        }

        // Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏ ÌôïÏù∏
        function isCheckmate(color) {
            checkForCheck();
            
            // Ï≤¥ÌÅ¨ ÏÉÅÌÉúÍ∞Ä ÏïÑÎãàÎ©¥ Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏Í∞Ä ÏïÑÎãò
            if (!isInCheck[color]) return false;
            
            // Î™®Îì† Í∞ÄÎä•Ìïú Ïù¥ÎèôÏùÑ ÌôïÏù∏
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = board[row][col];
                    if (piece && getPieceColor(piece) === color) {
                        for (let toRow = 0; toRow < 8; toRow++) {
                            for (let toCol = 0; toCol < 8; toCol++) {
                                if (isValidMove(row, col, toRow, toCol)) {
                                    if (wouldResolveCheck(row, col, toRow, toCol, color)) {
                                        return false; // Ï≤¥ÌÅ¨Î•º Ìï¥Í≤∞Ìï† Ïàò ÏûàÎäî Ïù¥ÎèôÏù¥ ÏûàÏùå
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            return true; // Ï≤¥ÌÅ¨Î•º Ìï¥Í≤∞Ìï† Ïù¥ÎèôÏù¥ ÏóÜÏùå = Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏
        }

        // ÌîÑÎ°úÎ™®ÏÖò ÏÑ†ÌÉù
        function selectPromotion(pieceType) {
            if (!pendingPromotion) return;
            
            const pieces = {
                queen: pendingPromotion.color === 'white' ? '‚ôï' : '‚ôõ',
                rook: pendingPromotion.color === 'white' ? '‚ôñ' : '‚ôú',
                bishop: pendingPromotion.color === 'white' ? '‚ôó' : '‚ôù',
                knight: pendingPromotion.color === 'white' ? '‚ôò' : '‚ôû'
            };
            
            board[pendingPromotion.row][pendingPromotion.col] = pieces[pieceType];
            
            document.getElementById('promotionModal').style.display = 'none';
            pendingPromotion = null;
            
            // ÌîåÎ†àÏù¥Ïñ¥ Î≥ÄÍ≤Ω
            currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
            
            // Î≥¥Îìú Î®ºÏ†Ä Î†åÎçîÎßÅ
            renderBoard();
            updateGameStatus();
            
            // Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏ ÌôïÏù∏ (Î≥¥Îìú Î†åÎçîÎßÅ ÌõÑ)
            setTimeout(() => {
                if (isCheckmate(currentPlayer)) {
                    isGameOver = true;
                    const winner = currentPlayer === 'white' ? 'Ìùë' : 'Î∞±';
                    document.getElementById('gameStatus').textContent = `Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏! ${winner}Ïùò ÏäπÎ¶¨!`;
                    playCheckmateSound();
                    return;
                }
                
                // AI Ï∞®Î°ÄÎùºÎ©¥ AI Ïù¥Îèô
                if (currentPlayer === 'black' && !isGameOver) {
                    setTimeout(() => {
                        aiMove();
                    }, 500);
                }
            }, 100);
        }

        // Í≥†Í∏â AI Ïù¥Îèô ÏÑ†ÌÉù (ÎÇúÏù¥ÎèÑ 6)
        function getBestMoveAdvanced(possibleMoves) {
            let bestMove = null;
            let bestScore = -10000;
            
            for (const move of possibleMoves) {
                // Ïù¥Îèô ÏãúÎÆ¨Î†àÏù¥ÏÖò
                const originalPiece = board[move.to[0]][move.to[1]];
                board[move.to[0]][move.to[1]] = board[move.from[0]][move.from[1]];
                board[move.from[0]][move.from[1]] = null;
                
                // ÏÉÅÎåÄÎ∞©Ïùò ÏµúÏÑ† ÏùëÏàò Í≥†Î†§ (1Ïàò Ïïû ÏùΩÍ∏∞)
                let worstResponse = 10000;
                const opponentMoves = getAllPossibleMoves('white');
                
                for (const opMove of opponentMoves.slice(0, 10)) { // ÏÑ±Îä•ÏùÑ ÏúÑÌï¥ ÏÉÅÏúÑ 10Í∞úÎßå Ï≤¥ÌÅ¨
                    const opOriginal = board[opMove.to[0]][opMove.to[1]];
                    board[opMove.to[0]][opMove.to[1]] = board[opMove.from[0]][opMove.from[1]];
                    board[opMove.from[0]][opMove.from[1]] = null;
                    
                    const score = evaluateBoard();
                    if (score < worstResponse) {
                        worstResponse = score;
                    }
                    
                    // Î≥µÏõê
                    board[opMove.from[0]][opMove.from[1]] = board[opMove.to[0]][opMove.to[1]];
                    board[opMove.to[0]][opMove.to[1]] = opOriginal;
                }
                
                // Ï¶âÏãú ÏäπÎ¶¨ Ï≤¥ÌÅ¨
                if (originalPiece === '‚ôî') {
                    worstResponse = 10000; // ÌÇπÏùÑ Ïû°ÏúºÎ©¥ Ï¶âÏãú ÏäπÎ¶¨
                }
                
                // Ï≤¥ÌÅ¨Î©îÏù¥Ìä∏ ÏúÑÌòë Ï≤¥ÌÅ¨
                const whiteKing = findKing('white');
                if (whiteKing && isValidMove(move.from[0], move.from[1], whiteKing[0], whiteKing[1])) {
                    worstResponse += 500; // Ï≤¥ÌÅ¨ Î≥¥ÎÑàÏä§
                }
                
                if (worstResponse > bestScore) {
                    bestScore = worstResponse;
                    bestMove = move;
                }
                
                // Î≥µÏõê
                board[move.from[0]][move.from[1]] = board[move.to[0]][move.to[1]];
                board[move.to[0]][move.to[1]] = originalPiece;
            }
            
            return bestMove || possibleMoves[0];
        }

        // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateGameStatus() {
            if (isGameOver) return;
            
            const statusText = currentPlayer === 'white' ? 'ÎãπÏã†Ïùò Ï∞®Î°ÄÏûÖÎãàÎã§ (Î∞±)' : 'AIÏùò Ï∞®Î°ÄÏûÖÎãàÎã§ (Ìùë)';
            document.getElementById('gameStatus').textContent = statusText;
        }

        // ÏÉà Í≤åÏûÑ
        function newGame() {
            initializeBoard();
            selectedSquare = null;
            currentPlayer = 'white';
            gameHistory = [];
            isGameOver = false;
            enPassantTarget = null;
            pendingPromotion = null;
            isInCheck = { white: false, black: false };
            clearHighlights();
            renderBoard();
            updateGameStatus();
            document.getElementById('thinking').style.display = 'none';
            document.getElementById('promotionModal').style.display = 'none';
        }

        // Î¨¥Î•¥Í∏∞
        function undoMove() {
            if (gameHistory.length < 2) return; // AIÏôÄ ÌîåÎ†àÏù¥Ïñ¥ Îëò Îã§ Î¨¥Î•¥Í∏∞
            
            // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Îèô Î¨¥Î•¥Í∏∞
            const playerMove = gameHistory.pop();
            board[playerMove.from[0]][playerMove.from[1]] = playerMove.piece;
            board[playerMove.to[0]][playerMove.to[1]] = playerMove.captured;
            
            // ÏïôÌååÏÉÅ Î≥µÏõê
            if (playerMove.isEnPassant) {
                const capturedRow = playerMove.piece === '‚ôô' ? playerMove.to[0] + 1 : playerMove.to[0] - 1;
                board[capturedRow][playerMove.to[1]] = playerMove.piece === '‚ôô' ? '‚ôü' : '‚ôô';
            }
            
            // AI Ïù¥Îèô Î¨¥Î•¥Í∏∞
            if (gameHistory.length > 0) {
                const aiMove = gameHistory.pop();
                board[aiMove.from[0]][aiMove.from[1]] = aiMove.piece;
                board[aiMove.to[0]][aiMove.to[1]] = aiMove.captured;
                
                // AI ÏïôÌååÏÉÅ Î≥µÏõê
                if (aiMove.isEnPassant) {
                    const capturedRow = aiMove.piece === '‚ôô' ? aiMove.to[0] + 1 : aiMove.to[0] - 1;
                    board[capturedRow][aiMove.to[1]] = aiMove.piece === '‚ôô' ? '‚ôü' : '‚ôô';
                }
                
                enPassantTarget = aiMove.enPassantTarget;
            }
            
            currentPlayer = 'white';
            isGameOver = false;
            selectedSquare = null;
            pendingPromotion = null;
            clearHighlights();
            renderBoard();
            updateGameStatus();
            document.getElementById('thinking').style.display = 'none';
            document.getElementById('promotionModal').style.display = 'none';
        }

        // ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï
        function setDifficulty(level) {
            aiDifficulty = level;
            
            // Î™®Îì† ÎÇúÏù¥ÎèÑ Î≤ÑÌäºÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÎÇúÏù¥ÎèÑ Î≤ÑÌäºÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            event.target.classList.add('active');
        }

        // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
        initializeBoard();
        renderBoard();
        updateGameStatus();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'982308ba934a8b6a',t:'MTc1ODM4OTI1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
